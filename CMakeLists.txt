cmake_minimum_required( VERSION 3.2 ) 

if( NOT ROOT_DIRECTORY )
    set( ROOT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} )
    if ( NOT fetched_subprojects )
        if ( NOT PYTHON_EXECUTABLE )
            find_package( PythonInterp )
            if ( NOT PYTHONINTERP_FOUND )
                message( FATAL_ERROR "Python interpeter installation was not found." )
            endif()
        endif()
        execute_process( COMMAND ${PYTHON_EXECUTABLE} "./metaconfigure/fetch_subprojects.py"
                         WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} 
                         RESULT_VARIABLE fetch_failure )
        if ( NOT fetch_failure )
            set( fetched_subprojects TRUE CACHE BOOL "fetch script ran" )
        else()
            message( FATAL_ERROR "Failed to fetch dependencies" )
        endif()
    endif()
endif()

if( NOT DEFINED build_type )
    if( VERBOSE )
        message( STATUS "build_type variable not specified")
        message( STATUS "build_type defaulted to debug")
    endif()
    set ( build_type "debug" )
endif()
if( NOT DEFINED njoy21_build_type )
    if( VERBOSE )
        message( STATUS "njoy21_build_type not specified")
        message( STATUS "njoy21_build_type defaulted to value of build_type variable")
    endif()
    set( njoy21_build_type "${build_type}" )
 endif()

if( NOT DEFINED static_libraries )
    if( VERBOSE )
        message( STATUS "static_libraries variable not specified")
        message( STATUS "static_libraries defaulted to FALSE")
    endif()
    set( build_static_libraries FALSE )
else()
    set( build_static_libraries ${static_libraries} )
endif()

project( njoy21 VERSION 0.0.1 LANGUAGES CXX )

get_directory_property( is_subproject PARENT_DIRECTORY )
if( NOT TARGET hana-adapter )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/hana-adapter )
endif()
if( NOT TARGET catch-adapter )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/catch-adapter )
endif()
if( NOT TARGET dimwits )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/dimwits )
endif()
if( NOT TARGET tclap-adapter )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/tclap-adapter )
endif()
if( NOT TARGET fmt-adapter )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/fmt-adapter )
endif()
if( NOT TARGET spdlog-adapter )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/spdlog-adapter )
endif()
if( NOT TARGET Log )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/Log )
endif()
if( NOT TARGET header-utilities )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/header-utilities )
endif()
if( NOT TARGET utility )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/utility )
endif()
if( NOT TARGET hana-adapter )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/hana-adapter )
endif()
if( NOT TARGET dimwits )
    add_subdirectory( ${ROOT_DIRECTORY}/subprojects/dimwits )
endif()

if( NOT is_subproject )
    if( DEFINED CXX_compiler_flags )
        if( ( NOT DEFINED njoy21_compiler_flags ) AND ( NOT DEFINED njoy21_use_default_compiler_flags ) )
            set( njoy21_compiler_flags "${CXX_compiler_flags}" )
        endif()
    endif()
    if( NOT DEFINED njoy21_compiler_flags )
        if( CMAKE_CXX_COMPILER_ID STREQUAL "GNU" )
            if( njoy21_build_type STREQUAL "debug" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -g -gdwarf-3" )
            elseif( njoy21_build_type STREQUAL "coverage" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -g -gdwarf-3 -fprofile-arcs -ftest-coverage -fno-inline" )
            elseif( njoy21_build_type STREQUAL "release" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -O3 -DNDEBUG" )
                if( NOT no_link_time_optimization )
                    set( njoy21_compiler_flags "${njoy21_compiler_flags} -flto" )
                endif()
            elseif( njoy21_build_type STREQUAL "native" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -O3 -DNDEBUG -march=native" )
                if( NOT no_link_time_optimization )
                    set( njoy21_compiler_flags "${njoy21_compiler_flags} -flto" )
                endif()
            endif()
        elseif( CMAKE_CXX_COMPILER_ID STREQUAL "Clang" )
            if( njoy21_build_type STREQUAL "debug" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -g -gdwarf-3" )
            elseif( njoy21_build_type STREQUAL "coverage" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -g -gdwarf-3 -fprofile-arcs -ftest-coverage -fno-inline" )
            elseif( njoy21_build_type STREQUAL "release" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -O3 -DNDEBUG" )
                if( NOT no_link_time_optimization )
                    set( njoy21_compiler_flags "${njoy21_compiler_flags} -flto" )
                endif()
            elseif( njoy21_build_type STREQUAL "native" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -O3 -DNDEBUG -march=native" )
                if( NOT no_link_time_optimization )
                    set( njoy21_compiler_flags "${njoy21_compiler_flags} -flto" )
                endif()
            endif()
        elseif( CMAKE_CXX_COMPILER_ID STREQUAL "AppleClang" )
            if( njoy21_build_type STREQUAL "debug" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -g -gdwarf-3" )
            elseif( njoy21_build_type STREQUAL "coverage" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -g -gdwarf-3 -fprofile-arcs -ftest-coverage -fno-inline" )
            elseif( njoy21_build_type STREQUAL "release" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -O3 -DNDEBUG" )
                if( NOT no_link_time_optimization )
                    set( njoy21_compiler_flags "${njoy21_compiler_flags} -flto" )
                endif()
            elseif( njoy21_build_type STREQUAL "native" )
                set( njoy21_compiler_flags "-std=c++14 -Wall -Wextra -Wpedantic -Werror -O3 -DNDEBUG -march=native" )
                if( NOT no_link_time_optimization )
                    set( njoy21_compiler_flags "${njoy21_compiler_flags} -flto" )
                endif()
            endif()
        else()
            message( WARNING "Compiler vendor not recognized. No compilation flags set" )
        endif()
    endif()
    if( DEFINED appended_flags AND NOT njoy21_no_appended_flags )
        set( njoy21_compiler_flags "${njoy21_compiler_flags} ${appended_flags}" )
    endif()
    if( DEFINED njoy21_appended_flags )
        set( njoy21_compiler_flags "${njoy21_compiler_flags} ${njoy21_appended_flags}" )
    endif()
endif()

if ( NOT GIT_EXECUTABLE )
    find_package( Git )
    if ( NOT GIT_FOUND )
        message( FATAL_ERROR "git installation was not found." )
    endif()
endif()
execute_process(
    COMMAND ${GIT_EXECUTABLE} rev-parse --abbrev-ref HEAD
    WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
    OUTPUT_VARIABLE GIT_BRANCH
    OUTPUT_STRIP_TRAILING_WHITESPACE
)
execute_process(
    COMMAND ${GIT_EXECUTABLE} rev-parse HEAD
    WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
    OUTPUT_VARIABLE GIT_HASH
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

message( STATUS "" )
message( STATUS "-----------------------------------------------------------" )
message( STATUS "" )
message( STATUS "njoy21 Version: 0.0.1" )
message( STATUS "Git current branch: ${GIT_BRANCH}" )
message( STATUS "Git commit hash: ${GIT_HASH}" )
message( STATUS "" )
if( NOT is_subproject ) 
    message( STATUS "njoy21 flags: ${njoy21_compiler_flags}" ) 
    message( STATUS "" ) 
endif() 
message( STATUS "-----------------------------------------------------------" ) 
message( STATUS "" ) 

add_library( njoy21 INTERFACE )
target_include_directories( njoy21 INTERFACE src )
target_link_libraries( njoy21 INTERFACE dimwits INTERFACE tclap-adapter INTERFACE utility INTERFACE Log ) 

if( NOT is_subproject ) 
    enable_testing() 
    # add_subdirectory( src/njoy21/input/RECONR/Card4/test ) 
    # add_subdirectory( src/njoy21/input/GASPR/Card1/Nin/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card2/Tapeid/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card3/test ) 
    add_subdirectory( src/njoy21/input/argument/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card1/test ) 
    add_subdirectory( src/njoy21/input/argument/Type/test ) 
    add_subdirectory( src/njoy21/input/Label/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card3/Nin/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/test ) 
    add_subdirectory( src/njoy21/input/Card/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card3/Errint/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card3/Ngrid/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card3/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card3/Mat/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card1/Nendf/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card1/Nout/test ) 
    # add_subdirectory( src/njoy21/input/MODER/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card1/Nin/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card2/Istart/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card5/Cards/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card2/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card2/Istrap/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card4/Errint/test ) 
    add_subdirectory( src/njoy21/input/argument/primitive/Type/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card5/Mat1/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card4/Tempr/test ) 
    add_subdirectory( src/njoy21/input/argument/primitive/Discriminating/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card1/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card5/test ) 
    add_subdirectory( src/njoy21/input/argument/primitive/Defaulted/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card3/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card5/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card4/Err/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card3/Ncards/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card1/Nendf/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card2/Mat1/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card2/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card4/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card3/Errthn/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card2/test ) 
    # add_subdirectory( src/njoy21/input/GASPR/Card1/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card2/Temp1/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card1/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card3/Thnmax/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card6/Enode/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card2/Ntemp2/test ) 
    # add_subdirectory( src/njoy21/input/GASPR/Card1/Nendf/test ) 
    # add_subdirectory( src/njoy21/input/GASPR/Card1/Nout/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card4/Errmax/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card4/Temp2/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card3/Errmax/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card2/Tlabel/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card1/Nin/test ) 
    add_subdirectory( src/njoy21/input/argument/primitive/Required/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card6/test ) 
    # add_subdirectory( src/njoy21/input/BROADR/Card1/Nout/test ) 
    # add_subdirectory( src/njoy21/input/RECONR/Card1/Npend/test ) 
    add_subdirectory( src/njoy21/input/argument/primitive/Optional/test ) 
    # add_subdirectory( src/njoy21/input/MODER/Card3/Matd/test ) 
endif() 
